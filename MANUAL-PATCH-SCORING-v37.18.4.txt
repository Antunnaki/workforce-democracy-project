=================================================================
MANUAL PATCH FOR ai-service.js - v37.18.4
FIXES: Congress.gov bills scoring 0
=================================================================

LOCATION: /var/www/workforce-democracy/version-b/backend/ai-service.js
FUNCTION: scoreSourceRelevance (line 886)

=================================================================
CHANGE 1: Add description and content fields to scoring
=================================================================

FIND (around line 890):
```javascript
function scoreSourceRelevance(source, query) {
    const queryLower = query.toLowerCase();
    const titleLower = (source.title || '').toLowerCase();
    const excerptLower = (source.excerpt || '').toLowerCase();
    const combined = `${titleLower} ${excerptLower}`;
```

REPLACE WITH:
```javascript
function scoreSourceRelevance(source, query) {
    const queryLower = query.toLowerCase();
    const titleLower = (source.title || '').toLowerCase();
    const excerptLower = (source.excerpt || '').toLowerCase();
    const descriptionLower = (source.description || '').toLowerCase();
    const contentLower = (source.content || '').toLowerCase();
    const combined = `${titleLower} ${excerptLower} ${descriptionLower} ${contentLower}`;
```

=================================================================
CHANGE 2: Add government source bonus (INSERT AFTER LINE 910)
=================================================================

FIND (around line 910, after music filter, BEFORE "let score = 100;"):
```javascript
    if (titleLower.match(/^(song|album|music|concert|artist|band):/i) && !combined.match(/policy|worker|labor|benefit|union|strike/i)) {
        console.log(`  üö´ ENTERTAINMENT FILTERED: "${source.title.substring(0, 60)}..."`);
        return -1000;
    }
    
    let score = 100; // Base score
```

INSERT THIS CODE BLOCK BETWEEN THE ENTERTAINMENT FILTER AND "let score = 100;":
```javascript
    
    // ==================================================================
    // GOVERNMENT SOURCE BONUS (v37.18.4)
    // ==================================================================
    // Congress.gov bills and .gov sources are PRIMARY SOURCES
    // Give them GUARANTEED high score to bypass topic filters
    const isGovSource = (source.url && (
        source.url.includes('congress.gov') ||
        source.url.includes('.gov') ||
        source.url.includes('senate.gov') ||
        source.url.includes('house.gov')
    ));
    
    const isCongressBill = source.type === 'congress_bill' || source.metadata?.billNumber;
    
    // MASSIVE bonus for government sources to override topic filters
    if (isGovSource || isCongressBill) {
        console.log(`  üèõÔ∏è  GOVERNMENT SOURCE: "${source.title?.substring(0, 50)}..." ‚Üí SCORE: 500`);
        return 500; // GUARANTEED to pass threshold (threshold is 30)
    }
    
    let score = 100; // Base score
```

=================================================================
RESULT AFTER PATCHING:
=================================================================

The function should now look like this around lines 886-935:

```javascript
function scoreSourceRelevance(source, query) {
    const queryLower = query.toLowerCase();
    const titleLower = (source.title || '').toLowerCase();
    const excerptLower = (source.excerpt || '').toLowerCase();
    const descriptionLower = (source.description || '').toLowerCase();
    const contentLower = (source.content || '').toLowerCase();
    const combined = `${titleLower} ${excerptLower} ${descriptionLower} ${contentLower}`;
    
    // ==================================================================
    // MUSIC/ENTERTAINMENT FILTER (v37.8.0)
    // ==================================================================
    // Filter out music/entertainment articles BEFORE scoring
    // Check TITLE ONLY first (more specific)
    if (titleLower.match(/turn it up|hero with a hero|icing on the cake/i)) {
        console.log(`  üö´ MUSIC FILTERED (title): "${source.title.substring(0, 60)}..."`);
        return -1000; // Immediate rejection
    }
    // Then check combined for generic music content
    if (combined.match(/music review|album review|concert review|song of the week/i)) {
        console.log(`  üö´ MUSIC FILTERED (content): "${source.title.substring(0, 60)}..."`);
        return -1000; // Immediate rejection
    }
    
    // Filter out generic entertainment that's clearly not policy-related
    if (titleLower.match(/^(song|album|music|concert|artist|band):/i) && !combined.match(/policy|worker|labor|benefit|union|strike/i)) {
        console.log(`  üö´ ENTERTAINMENT FILTERED: "${source.title.substring(0, 60)}..."`);
        return -1000;
    }
    
    // ==================================================================
    // GOVERNMENT SOURCE BONUS (v37.18.4)
    // ==================================================================
    // Congress.gov bills and .gov sources are PRIMARY SOURCES
    // Give them GUARANTEED high score to bypass topic filters
    const isGovSource = (source.url && (
        source.url.includes('congress.gov') ||
        source.url.includes('.gov') ||
        source.url.includes('senate.gov') ||
        source.url.includes('house.gov')
    ));
    
    const isCongressBill = source.type === 'congress_bill' || source.metadata?.billNumber;
    
    // MASSIVE bonus for government sources to override topic filters
    if (isGovSource || isCongressBill) {
        console.log(`  üèõÔ∏è  GOVERNMENT SOURCE: "${source.title?.substring(0, 50)}..." ‚Üí SCORE: 500`);
        return 500; // GUARANTEED to pass threshold (threshold is 30)
    }
    
    let score = 100; // Base score
    
    // ==================================================================
    // TOPIC-SPECIFIC FILTERING
    // ==================================================================
    // ... rest of function continues ...
```

=================================================================
DEPLOYMENT STEPS:
=================================================================

1. SSH to VPS:
   ssh root@185.193.126.13

2. Navigate to backend:
   cd /var/www/workforce-democracy/version-b/backend

3. Backup ai-service.js:
   cp ai-service.js ai-service-BACKUP-before-scoring-patch-$(date +%Y%m%d-%H%M%S).js

4. Edit ai-service.js:
   nano ai-service.js

5. Go to line 890 (Ctrl+_ then type 890):
   - Apply CHANGE 1 (add description and content fields)

6. Go to line 910:
   - Apply CHANGE 2 (add government source bonus)

7. Save and exit:
   Ctrl+X, then Y, then Enter

8. Check syntax:
   node -c ai-service.js

9. Restart backend:
   sudo systemctl restart workforce-backend-b.service

10. Test:
    See TESTING COMMANDS below

=================================================================
TESTING COMMANDS:
=================================================================

# Submit test query
curl -X POST "http://localhost:3002/api/civic/llm-chat/submit" \
  -H "Content-Type: application/json" \
  -d '{"message": "How has Chuck Schumer voted on healthcare?", "context": {"page": "civic-platform", "section": "my-representatives", "viewingContent": {"type": "representative", "name": "Charles E. Schumer", "state": "NY", "chamber": "senate"}}}' | jq '.jobId'

# Wait 30 seconds, then check result (replace JOBID)
sleep 30
curl "http://localhost:3002/api/civic/llm-chat/result/JOBID" | jq '.result.sources[] | {title, url}'

# Check logs for government source detection
tail -100 /var/log/workforce-backend-b.log | grep "GOVERNMENT SOURCE"

=================================================================
EXPECTED RESULTS AFTER PATCH:
=================================================================

BEFORE:
  Removed sources with scores: Congress.gov: 0, Congress.gov: 0...
  "sources": []

AFTER:
  üèõÔ∏è  GOVERNMENT SOURCE: "HR 1512 - Taiwan Assurance..." ‚Üí SCORE: 500
  üèõÔ∏è  GOVERNMENT SOURCE: "S 2341 - Healthcare Reform..." ‚Üí SCORE: 500
  "sources": [
    {
      "title": "HR 1512 - Taiwan Assurance Implementation Act",
      "url": "https://www.congress.gov/bill/..."
    }
  ]

=================================================================
