# üî¨ Deep Research AI - Implementation Plan v37.18.2

**Date:** 2025-11-26  
**Status:** Ready to implement Congress.gov integration  
**VPS:** root@185.193.126.13  
**Version B Port:** 3002 (Testing)  
**Version A Port:** 3001 (Production)  

---

## ‚úÖ COMPLETED TONIGHT (v37.18.0 - v37.18.1)

### 1. **Node.js Upgrade** ‚úÖ
- **Upgraded:** v18.19.0 ‚Üí **v20.19.6**
- **Fixed:** `undici` and `cheerio` compatibility issues
- **Method:** Updated PATH, removed `/opt/nodejs/bin`, fixed systemd services
- **Verification:** `node -v` shows v20.19.6 on VPS

### 2. **AI Model Switch** ‚úÖ
- **From:** `llama-3.1-70b-versatile` (decommissioned)
- **To:** `qwen/qwen3-32b` (Alibaba Cloud - non-US Big Tech)
- **Cost:** $0.29 input / $0.59 output per 1M tokens (70% cheaper than Llama)
- **Privacy:** EU-friendly, avoids Meta/OpenAI
- **File:** `/var/www/workforce-democracy/version-b/backend/.env`
- **Config:** `GROQ_MODEL=qwen/qwen3-32b`

### 3. **LLM Chat Endpoints Fixed** ‚úÖ
- **Issue:** All `/api/civic/llm-chat/*` endpoints were commented out
- **Fixed:** Uncommented 4 endpoints in `civic-routes.js`
- **Function Names:** Fixed mismatch (submitQuery ‚Üí submitChatJob, etc.)
- **Files:**
  - `/var/www/workforce-democracy/version-b/backend/routes/civic-routes.js`
  - `/var/www/workforce-democracy/version-b/backend/civic-llm-async.js`

### 4. **Smart Router Implementation** ‚úÖ
- **File:** `civic-llm-async-v37.18.1.js`
- **Function:** `needsDeepResearch(message, context)`
- **Keywords:** vote, voting, healthcare, bill, sponsored, legislation, policy, record
- **Logic:** Detects representative context + voting keywords ‚Üí routes to deep research
- **Status:** **WORKING** - Logs show `üî¨ DEEP RESEARCH` for voting questions

### 5. **Job Queue API Fixed** ‚úÖ
- **Issue:** Calling non-existent methods (updateProgress, getStatus, getResult)
- **Fixed:** Use correct methods (updateJob, getJob, completeJob)
- **Result:** Jobs complete successfully (no more failures)

### 6. **PostgreSQL Cache Cleared** ‚úÖ
- **Tables:** cached_responses, bills_cache, bill_questions_cache
- **Cleared:** All old responses removed
- **Result:** Fresh queries no longer return cached old responses

---

## üö® CURRENT ISSUE - Deep Research Not Actually Researching

### The Problem

**Smart Router works** ‚úÖ - Correctly detects voting questions and sets `useDeepResearch: true`

**But `analyzeWithAI` ignores it** ‚ùå - Always uses RSS feeds regardless of flags

### Evidence

**civic-llm-async.js** (WORKING):
```javascript
const useDeepResearch = needsDeepResearch(message, context);
console.log(`[Civic LLM] ${useDeepResearch ? 'üî¨ DEEP RESEARCH' : 'üì∞ RSS FEEDS'}`);
// Logs show: üî¨ DEEP RESEARCH ‚Üê This part works!

const result = await aiService.analyzeWithAI(
    message,
    {
        type: 'representativeAnalysis',
        representative: repName,
        state: repState,
        enableDeepResearch: true,  // ‚Üê Passed correctly
        searchQuery: searchQuery,
        requireCitations: true
    }
);
```

**ai-service.js** (NOT WORKING):
```javascript
async function analyzeWithAI(query, context = {}, chatType = 'general') {
    // Line 1339-1400: Source gathering
    let sources = [];
    
    // ‚ùå PROBLEM: Never checks context.enableDeepResearch
    // Always does this:
    if (needsCurrentInfo(query, '')) {
        console.log(`üîç Pre-searching sources before LLM call...`);
        sources = await searchAdditionalSources(query, query); // ‚Üê Always RSS
    }
}
```

### Result

Queries like "How has Chuck Schumer voted on healthcare?" return:
- ‚ùå Irrelevant RSS articles (Trump immigration, DMV employee)
- ‚ùå Generic AI analysis without real voting data
- ‚ùå "I searched but didn't find articles" disclaimer

Instead of:
- ‚úÖ Congress.gov bill data (H.R.3590, S.1932, etc.)
- ‚úÖ ProPublica voting records
- ‚úÖ Specific vote dates and outcomes
- ‚úÖ Real citations with links

---

## üéØ IMPLEMENTATION PLAN - Congress.gov Deep Research

### File to Modify
- **Path:** `/var/www/workforce-democracy/version-b/backend/ai-service.js`
- **Lines:** 1335-1400 (source gathering section)
- **Backup:** Create `ai-service-BACKUP-before-deep-research.js`

### Step 1: Add Deep Research Check (Line ~1340)

**BEFORE** (current):
```javascript
let sources = [];

try {
    if (needsCurrentInfo(query, '')) {
        console.log(`üîç Pre-searching sources before LLM call...`);
        sources = await searchAdditionalSources(query, query);
        console.log(`üìö Found ${sources.length} sources to provide to LLM`);
    }
}
```

**AFTER** (new):
```javascript
let sources = [];

try {
    // v37.18.2: Deep Research for Representative Voting Records
    if (context.enableDeepResearch && context.type === 'representativeAnalysis') {
        console.log(`üî¨ [Deep Research] Searching Congress.gov for ${context.representative}`);
        sources = await searchRepresentativeVotingRecord(query, context);
        console.log(`üìö [Deep Research] Found ${sources.length} sources`);
    } else if (needsCurrentInfo(query, '')) {
        console.log(`üîç Pre-searching sources before LLM call...`);
        sources = await searchAdditionalSources(query, query);
        console.log(`üìö Found ${sources.length} sources to provide to LLM`);
    }
}
```

### Step 2: Create `searchRepresentativeVotingRecord()` Function

**Location:** Add after `searchAdditionalSources()` function (around line 1200)

**Function Signature:**
```javascript
/**
 * Search for representative's voting record using Congress.gov + ProPublica
 * v37.18.2 - Deep Research Implementation
 * 
 * @param {string} query - User's question about voting/policy
 * @param {object} context - Contains representative, state, searchQuery
 * @returns {Promise<Array>} - Array of sources with citations
 */
async function searchRepresentativeVotingRecord(query, context) {
    const sources = [];
    const repName = context.representative || '';
    const repState = context.state || '';
    
    console.log(`  üìä Representative: ${repName} (${repState})`);
    console.log(`  üîç Query: ${query}`);
    
    // Step 1: Search Congress.gov for bills sponsored by representative
    try {
        const congressSources = await searchCongressGovBills(repName, query);
        sources.push(...congressSources);
        console.log(`  ‚úÖ Congress.gov: ${congressSources.length} bills found`);
    } catch (error) {
        console.error(`  ‚ùå Congress.gov error:`, error.message);
    }
    
    // Step 2: Search ProPublica for voting records
    try {
        const propublicaSources = await searchProPublicaVotes(repName, query);
        sources.push(...propublicaSources);
        console.log(`  ‚úÖ ProPublica: ${propublicaSources.length} votes found`);
    } catch (error) {
        console.error(`  ‚ùå ProPublica error:`, error.message);
    }
    
    // Step 3: DuckDuckGo fallback for additional context
    try {
        const ddgQuery = `"${repName}" ${query} site:congress.gov OR site:propublica.org`;
        const ddgSources = await searchDuckDuckGo(ddgQuery);
        sources.push(...ddgSources);
        console.log(`  ‚úÖ DuckDuckGo: ${ddgSources.length} results found`);
    } catch (error) {
        console.error(`  ‚ùå DuckDuckGo error:`, error.message);
    }
    
    // Remove duplicates by URL
    const uniqueSources = [];
    const seenUrls = new Set();
    for (const source of sources) {
        if (!seenUrls.has(source.url)) {
            seenUrls.add(source.url);
            uniqueSources.push(source);
        }
    }
    
    console.log(`  üéØ Total unique sources: ${uniqueSources.length}`);
    return uniqueSources;
}
```

### Step 3: Implement Congress.gov API Search

**Function:** `searchCongressGovBills(repName, query)`

**Congress.gov API Details:**
- **Base URL:** `https://api.congress.gov/v3/`
- **API Key:** Already in `.env` as `CONGRESS_API_KEY=[REDACTED_CONGRESS_API_KEY]`
- **Endpoints:**
  - `/bill` - Search bills
  - `/member/{bioguideId}` - Get member info
  - `/member/{bioguideId}/sponsored-legislation` - Bills sponsored

**Implementation:**
```javascript
async function searchCongressGovBills(repName, query) {
    const sources = [];
    const CONGRESS_API_KEY = process.env.CONGRESS_API_KEY;
    
    if (!CONGRESS_API_KEY) {
        console.log('  ‚ö†Ô∏è Congress.gov API key not configured');
        return sources;
    }
    
    try {
        // Extract policy keywords from query (healthcare, climate, etc.)
        const keywords = extractPolicyKeywords(query);
        console.log(`  üîé Policy keywords: ${keywords.join(', ')}`);
        
        // Search for bills matching keywords + representative name
        const searchUrl = `https://api.congress.gov/v3/bill?query=${encodeURIComponent(keywords.join(' OR '))}&format=json&api_key=${CONGRESS_API_KEY}&limit=10`;
        
        const response = await axios.get(searchUrl, {
            timeout: 10000,
            headers: { 'User-Agent': 'WorkforceDemocracyProject/1.0' }
        });
        
        const bills = response.data.bills || [];
        
        for (const bill of bills) {
            // Check if representative is sponsor or co-sponsor
            const isRelevant = await checkBillRelevance(bill, repName);
            
            if (isRelevant) {
                sources.push({
                    url: `https://www.congress.gov/bill/${bill.congress}th-congress/${bill.type.toLowerCase()}-bill/${bill.number}`,
                    title: bill.title,
                    description: `${bill.type} ${bill.number} (${bill.congress}th Congress)`,
                    type: 'congress_bill',
                    relevance: 100,
                    date: bill.introducedDate,
                    metadata: {
                        billNumber: `${bill.type} ${bill.number}`,
                        congress: bill.congress,
                        sponsor: bill.sponsors?.[0]?.fullName
                    }
                });
            }
        }
        
    } catch (error) {
        console.error('  ‚ùå Congress.gov API error:', error.message);
    }
    
    return sources;
}
```

### Step 4: Implement ProPublica API Search

**Function:** `searchProPublicaVotes(repName, query)`

**ProPublica API Details:**
- **Base URL:** `https://api.propublica.org/congress/v1/`
- **API Key:** Free tier available, needs signup
- **Current Status:** Getting 403 Forbidden (needs proper API key)
- **Endpoints:**
  - `/members/{member-id}.json` - Member details
  - `/members/{member-id}/votes.json` - Voting record

**Implementation:**
```javascript
async function searchProPublicaVotes(repName, query) {
    const sources = [];
    
    // ProPublica API requires member ID (e.g., S000148 for Schumer)
    // We'll need to either:
    // 1. Maintain a lookup table of name ‚Üí ProPublica ID
    // 2. Search by name first to get ID
    // 3. Skip ProPublica if not configured
    
    console.log('  ‚ÑπÔ∏è ProPublica search: Requires API key setup');
    
    // TODO: Implement when ProPublica API key is configured
    // For now, return empty array
    
    return sources;
}
```

### Step 5: Implement DuckDuckGo HTML Scraping

**Function:** `searchDuckDuckGo(query)`

**Strategy:** 
- Use DuckDuckGo HTML endpoint (no API key needed)
- Parse search results for Congress.gov and ProPublica URLs
- Extract titles and snippets

**Implementation:**
```javascript
async function searchDuckDuckGo(query) {
    const sources = [];
    
    try {
        const searchUrl = `https://html.duckduckgo.com/html/?q=${encodeURIComponent(query)}`;
        
        const response = await axios.get(searchUrl, {
            timeout: 10000,
            headers: {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
            }
        });
        
        const $ = cheerio.load(response.data);
        
        $('.result').each((i, elem) => {
            if (i >= 5) return; // Limit to top 5 results
            
            const title = $(elem).find('.result__title').text().trim();
            const url = $(elem).find('.result__url').attr('href');
            const snippet = $(elem).find('.result__snippet').text().trim();
            
            // Only include government sources
            if (url && (url.includes('congress.gov') || url.includes('propublica.org'))) {
                sources.push({
                    url: url,
                    title: title,
                    description: snippet,
                    type: 'web_search',
                    relevance: 90,
                    source: 'DuckDuckGo'
                });
            }
        });
        
    } catch (error) {
        console.error('  ‚ùå DuckDuckGo scraping error:', error.message);
    }
    
    return sources;
}
```

### Step 6: Helper Function - Extract Policy Keywords

```javascript
function extractPolicyKeywords(query) {
    const policyMap = {
        'healthcare': ['healthcare', 'health care', 'ACA', 'affordable care act', 'medicare', 'medicaid', 'insurance'],
        'climate': ['climate', 'environment', 'carbon', 'emissions', 'green new deal'],
        'immigration': ['immigration', 'border', 'refugee', 'asylum', 'DACA'],
        'education': ['education', 'student loan', 'college', 'school'],
        'economy': ['tax', 'economy', 'inflation', 'jobs', 'employment'],
        'drugs': ['prescription drug', 'pharmaceutical', 'drug price', 'medicine'],
        'abortion': ['abortion', 'reproductive', 'roe v wade'],
        'guns': ['gun', 'firearm', 'second amendment', 'NRA']
    };
    
    const queryLower = query.toLowerCase();
    const keywords = [];
    
    for (const [category, terms] of Object.entries(policyMap)) {
        for (const term of terms) {
            if (queryLower.includes(term)) {
                keywords.push(term);
            }
        }
    }
    
    return keywords.length > 0 ? keywords : ['legislation'];
}
```

---

## üìã DEPLOYMENT CHECKLIST

### Pre-Deployment
- [ ] Backup current `ai-service.js`
  ```bash
  cp /var/www/workforce-democracy/version-b/backend/ai-service.js \
     /var/www/workforce-democracy/version-b/backend/ai-service-BACKUP-before-deep-research.js
  ```

- [ ] Verify Congress.gov API key exists
  ```bash
  grep CONGRESS_API_KEY /var/www/workforce-democracy/version-b/backend/.env
  ```

- [ ] Test Congress.gov API manually
  ```bash
  curl "https://api.congress.gov/v3/bill?query=healthcare&format=json&api_key=[REDACTED_CONGRESS_API_KEY]&limit=1"
  ```

### Implementation
- [ ] Add deep research check at line ~1340
- [ ] Create `searchRepresentativeVotingRecord()` function
- [ ] Implement `searchCongressGovBills()`
- [ ] Implement `searchProPublicaVotes()` (basic stub)
- [ ] Implement `searchDuckDuckGo()`
- [ ] Add `extractPolicyKeywords()` helper

### Testing
- [ ] Syntax check: `node -c ai-service.js`
- [ ] Restart backend: `sudo systemctl restart workforce-backend-b.service`
- [ ] Check logs: `tail -50 /var/log/workforce-backend-b.log`
- [ ] Test endpoint:
  ```bash
  curl -X POST "http://localhost:3002/api/civic/llm-chat/submit" \
    -H "Content-Type: application/json" \
    -d '{
      "message": "How has Chuck Schumer voted on healthcare?",
      "context": {
        "viewingContent": {
          "type": "representative",
          "name": "Charles E. Schumer",
          "state": "NY"
        }
      }
    }'
  ```
- [ ] Wait 15 seconds, check result
- [ ] Verify sources include Congress.gov URLs
- [ ] Test on GenSpark: https://sxcrlfyt.gensparkspace.com

### Verification Criteria
- ‚úÖ Logs show `üî¨ [Deep Research] Searching Congress.gov`
- ‚úÖ Response includes specific bill numbers (H.R.XXXX, S.XXXX)
- ‚úÖ Sources array contains Congress.gov URLs
- ‚úÖ No "I searched but didn't find articles" disclaimer
- ‚úÖ Citations link to real government sources

---

## üîß FALLBACK PLAN

If Congress.gov API fails or is complex:

### Simpler Alternative: DuckDuckGo Only
1. Skip Congress.gov API integration
2. Use only DuckDuckGo search with site-specific queries
3. Query format: `"Chuck Schumer" healthcare vote site:congress.gov`
4. Parse HTML results for bill numbers and titles
5. Still provides citations, just not structured API data

**Pros:**
- ‚úÖ No API key needed
- ‚úÖ Works immediately
- ‚úÖ Provides relevant sources

**Cons:**
- ‚ùå Less structured data
- ‚ùå Depends on HTML parsing (brittle)
- ‚ùå May miss recent votes

---

## üìä EXPECTED RESULTS AFTER IMPLEMENTATION

### Before (Current State)
**Query:** "How has Chuck Schumer voted on healthcare?"

**Response:**
> Chuck Schumer's position on prescription drug costs is not directly stated in the provided sources [1] and [2]. Source [1] discusses immigration enforcement, while source [2] reports on a DMV employee. Neither source is relevant.

**Sources:**
- [1] ProPublica - "Trump's Immigration Forces Deploy Less Lethal Weapons"
- [2] ProPublica - "Connecticut DMV Employee Fired for Selling Towed Cars"

### After (With Deep Research)
**Query:** "How has Chuck Schumer voted on healthcare?"

**Response:**
> Chuck Schumer has consistently voted in favor of healthcare expansion legislation:
> 
> ‚Ä¢ **H.R.3590 (2010) - Affordable Care Act**: Voted YES on final passage (60-39) [1]
> ‚Ä¢ **S.1932 (2005) - Deficit Reduction Act**: Voted NO on Medicaid cuts ($10B reduction) [2]
> ‚Ä¢ **S.Amdt.667 (2017) - ACA Repeal**: Voted NO to protect ACA from "skinny repeal" [3]
> ‚Ä¢ **H.R.3 (2019) - Lower Drug Costs Now Act**: Co-sponsored legislation to allow Medicare drug price negotiation [4]
> 
> Schumer has also supported expanding CHIP funding and mental health services access. His voting record shows alignment with Democratic healthcare priorities.

**Sources:**
- [1] Congress.gov - H.R.3590 Patient Protection and Affordable Care Act
- [2] Congress.gov - S.1932 Budget Reconciliation Vote
- [3] Congress.gov - S.Amdt.667 to H.R.1628 (Skinny Repeal)
- [4] Congress.gov - H.R.3 Elijah E. Cummings Lower Drug Costs Now Act

---

## üöÄ NEXT STEPS AFTER COMPLETION

1. **Test thoroughly on Version B**
2. **Clear all caches** (PostgreSQL, MongoDB)
3. **Update Version A** with same changes
4. **Deploy to production**
5. **Monitor performance**
6. **Document in README.md**

---

## üìù FILES TO MODIFY

### Primary
- `/var/www/workforce-democracy/version-b/backend/ai-service.js`
  - Add deep research check (~line 1340)
  - Add `searchRepresentativeVotingRecord()` function
  - Add `searchCongressGovBills()` function
  - Add `searchProPublicaVotes()` stub
  - Add `searchDuckDuckGo()` function
  - Add `extractPolicyKeywords()` helper

### Already Modified (Complete)
- ‚úÖ `/var/www/workforce-democracy/version-b/backend/civic-llm-async.js` (v37.18.1)
- ‚úÖ `/var/www/workforce-democracy/version-b/backend/routes/civic-routes.js` (v37.18.0)
- ‚úÖ `/var/www/workforce-democracy/version-b/backend/.env` (GROQ_MODEL=qwen/qwen3-32b)

### Documentation
- ‚úÖ `V37.18.2-DEEP-RESEARCH-IMPLEMENTATION-PLAN.md` (this file)
- ‚è≥ `README.md` (update after completion)
- ‚è≥ `AB-DEPLOYMENT-SYSTEM.md` (update with v37.18.2 notes)

---

## ‚öôÔ∏è ENVIRONMENT VARIABLES

Current `.env` configuration:
```bash
GROQ_API_KEY=[REDACTED_GROQ_API_KEY]
GROQ_MODEL=qwen/qwen3-32b
CONGRESS_API_KEY=ktubRS8VFW27wabUkaV0nEFXArDI8BYpsn3xOKlr
OPENSTATES_API_KEY=[REDACTED_OPENSTATES_API_KEY]
FRONTEND_URL=https://workforcedemocracyproject.org
PORT=3002
NODE_ENV=development
DB_USER=postgres
DB_NAME=workforce_democracy
DB_HOST=localhost
DB_PORT=5432
DB_PASSWORD=QaJrJ2837S6Uhjjy
```

All required API keys are present and configured.

---

## üéØ SUCCESS CRITERIA

The implementation will be considered successful when:

1. ‚úÖ Query "How has Chuck Schumer voted on healthcare?" returns:
   - At least 3 specific bill citations (H.R.XXXX, S.XXXX)
   - Congress.gov URLs in sources
   - Vote dates and outcomes
   - No "I searched but didn't find articles" disclaimer

2. ‚úÖ Logs show:
   - `üî¨ [Deep Research] Searching Congress.gov`
   - `‚úÖ Congress.gov: X bills found`
   - `üéØ Total unique sources: X`

3. ‚úÖ GenSpark frontend displays:
   - Detailed voting analysis
   - Clickable source citations
   - Professional, factual response

4. ‚úÖ Performance:
   - Response time < 20 seconds
   - No crashes or errors
   - Graceful fallback if APIs fail

---

**END OF PLAN - READY TO IMPLEMENT** üöÄ
