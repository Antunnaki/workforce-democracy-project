<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WDP Connectivity Diagnostic v2</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; max-width: 800px; margin: 0 auto; padding: 20px; background: #0f172a; color: #f8fafc; }
        .card { background: #1e293b; border-radius: 12px; padding: 20px; margin-bottom: 20px; border: 1px solid #334155; }
        .status { font-weight: bold; padding: 4px 8px; border-radius: 4px; }
        .success { background: #065f46; color: #34d399; }
        .error { background: #7f1d1d; color: #f87171; }
        .pending { background: #713f12; color: #fbbf24; }
        pre { background: #000; padding: 15px; border-radius: 8px; overflow-x: auto; font-size: 13px; color: #10b981; }
        button { background: #2563eb; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: background 0.2s; }
        button:hover { background: #1d4ed8; }
        h1, h2 { color: #fff; }
        .log-entry { margin-bottom: 10px; border-left: 3px solid #3b82f6; padding-left: 10px; }
    </style>
</head>
<body>
    <h1>WDP Connectivity Diagnostic v2</h1>
    <p>This tool verifies the connection between your Beta frontend and the API server.</p>

    <div class="card">
        <h2>1. Environment Info</h2>
        <div id="env-info">
            <p>Current Host: <code id="host">...</code></p>
            <p>API Base: <code id="api-base">...</code></p>
        </div>
    </div>

    <div class="card">
        <h2>2. Connection Tests</h2>
        <button onclick="runTests()">Run All Tests</button>
        <div id="results" style="margin-top: 20px;">
            <div class="log-entry">
                <strong>Preflight (OPTIONS) Test:</strong> <span id="preflight-status" class="status pending">Waiting...</span>
                <pre id="preflight-log">Results will appear here...</pre>
            </div>
            <div class="log-entry">
                <strong>API Health Test:</strong> <span id="health-status" class="status pending">Waiting...</span>
                <pre id="health-log">Results will appear here...</pre>
            </div>
            <div class="log-entry">
                <strong>Chat Endpoint Test:</strong> <span id="chat-status" class="status pending">Waiting...</span>
                <pre id="chat-log">Results will appear here...</pre>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin.includes('beta') 
            ? 'https://api-beta.workforcedemocracyproject.org' 
            : 'https://api.workforcedemocracyproject.org';
        
        document.getElementById('host').textContent = window.location.href;
        document.getElementById('api-base').textContent = API_BASE;

        async function runTests() {
            testPreflight();
            testHealth();
            testChat();
        }

        async function testPreflight() {
            const el = document.getElementById('preflight-status');
            const log = document.getElementById('preflight-log');
            el.textContent = 'Testing...';
            el.className = 'status pending';
            
            try {
                // We can't see the response headers of an OPTIONS request easily via fetch if it fails,
                // but we can try a request that triggers preflight.
                const start = Date.now();
                const response = await fetch(`${API_BASE}/api/civic/llm-chat`, {
                    method: 'OPTIONS',
                    headers: {
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type',
                        'Origin': window.location.origin
                    }
                });
                
                const duration = Date.now() - start;
                log.textContent = `Status: ${response.status} ${response.statusText}\n`;
                log.textContent += `Time: ${duration}ms\n`;
                
                if (response.ok || response.status === 204) {
                    el.textContent = 'Success';
                    el.className = 'status success';
                    log.textContent += `Preflight check passed. The server is accepting requests from ${window.location.origin}.`;
                } else {
                    el.textContent = 'Failed';
                    el.className = 'status error';
                    log.textContent += `Server returned ${response.status}. Preflight might be blocked.`;
                }
            } catch (err) {
                el.textContent = 'Error';
                el.className = 'status error';
                log.textContent = `Error: ${err.message}\n\nThis usually means the browser blocked the request due to CORS or a network failure.`;
            }
        }

        async function testHealth() {
            const el = document.getElementById('health-status');
            const log = document.getElementById('health-log');
            el.textContent = 'Testing...';
            el.className = 'status pending';
            
            try {
                const response = await fetch(`${API_BASE}/api/civic/llm-health`);
                const data = await response.json();
                
                log.textContent = JSON.stringify(data, null, 2);
                
                if (data.success) {
                    el.textContent = 'Success';
                    el.className = 'status success';
                } else {
                    el.textContent = 'Failed';
                    el.className = 'status error';
                }
            } catch (err) {
                el.textContent = 'Error';
                el.className = 'status error';
                log.textContent = `Error: ${err.message}`;
            }
        }

        async function testChat() {
            const el = document.getElementById('chat-status');
            const log = document.getElementById('chat-log');
            el.textContent = 'Testing...';
            el.className = 'status pending';
            
            try {
                const response = await fetch(`${API_BASE}/api/civic/llm-chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: "Hello diagnostic test", context: "general" })
                });
                const data = await response.json();
                
                log.textContent = JSON.stringify(data, null, 2);
                
                if (data.success) {
                    el.textContent = 'Success';
                    el.className = 'status success';
                } else {
                    el.textContent = 'Failed';
                    el.className = 'status error';
                }
            } catch (err) {
                el.textContent = 'Error';
                el.className = 'status error';
                log.textContent = `Error: ${err.message}`;
            }
        }
    </script>
</body>
</html>
